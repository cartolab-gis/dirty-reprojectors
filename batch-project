#!/usr/bin/env node

var fs = require('fs')
var path = require('path')
var bulk = require('bulk-require')
var d3 = require('d3-geo-projection')
var projections = bulk(__dirname, ['projections/*/*.js']).projections

// country-level geojsons
fs.readFile(path.join(__dirname, 'data/countries.geojson'), function (err, data) {
  if (err) { throw err }
  data = JSON.parse(data)
  write(data, projections.world)
})

// us-level geojsons
fs.readFile(path.join(__dirname, 'data/us-states.geojson'), function (err, data) {
  if (err) { throw err }
  data = JSON.parse(data)
  write(data, projections.us)
})

function write (data, projections) {
  for (var projection in projections) {
    if (typeof projections[projection] !== 'function') {
      throw new Error (projection + ' is not a valid projection')
    }
    var out = path.join(__dirname, 'output/geojson', projection + '.geojson')
    var reprojected = d3.geoProject(data, projections[projection])
    console.log('Writing ' + projection)
    fs.writeFile(out, JSON.stringify(d3.geoQuantize(reprojected, 5)), (err) => {
      if (err) { throw err }
    })
  }
}
